// @ts-check
//
// Creates a GitHub Release for each package listed in pnpm-publish-summary.json.
// Reads the changelog entry for each package and uses `gh release create`
// to publish it.
//
// The `hardhat` package is published as a draft (for human review) and marked as
// latest. All other packages are published immediately and not marked as latest.
//
// Prerequisites:
//   - `gh` CLI installed and authenticated (`gh auth login`)
//   - `pnpm-publish-summary.json` in the current directory
//     (generated by `pnpm publish --dry-run --report-summary`)
//
// Usage:
//   node scripts/github-release/create-releases.mjs            # create releases
//   node scripts/github-release/create-releases.mjs --dry-run  # preview without creating

import { execFileSync } from "node:child_process";

import {
  readPublishSummary,
  readChangelogsForPublishedPackages,
  buildGitHubCliReleaseArgs,
} from "./file-helpers.mjs";
import { buildReleaseDescriptors } from "./build-release-descriptors.mjs";

const dryRun = process.argv.includes("--dry-run");

const publishSummary = await readPublishSummary();

const changelogs = await readChangelogsForPublishedPackages(publishSummary);

const releases = buildReleaseDescriptors(publishSummary, changelogs);

for (const release of releases) {
  const args = buildGitHubCliReleaseArgs(release);

  if (dryRun) {
    console.log("------------------------------------------------------------");
    console.log("  tag:    ", release.tagName);
    console.log("  title:  ", release.title === "" ? "-" : release.title);
    console.log("  draft:  ", release.draft ? "true" : "false");
    console.log("  latest: ", release.latest ? "true" : "false");
    console.log("------------------------------------------------------------");
    console.log("");
    console.log(release.body);
    console.log("");

    continue;
  }

  let releaseExists = false;
  try {
    execFileSync("gh", ["release", "view", release.tagName], {
      stdio: "ignore",
    });
    releaseExists = true;
  } catch {
    // release doesn't exist yet
  }

  if (releaseExists) {
    console.log(`Skipping release (already exists): ${release.tagName}`);
    continue;
  }

  console.log(
    `Creating release: ${release.tagName} (draft=${release.draft}, latest=${release.latest})`,
  );

  try {
    execFileSync("gh", args, { stdio: "inherit" });
  } catch {
    // gh already printed its error to stderr above
    console.error(`\nFailed to create release: ${release.tagName}`);

    process.exit(1);
  }
}

console.log(dryRun ? "\nDry run complete." : "\nAll releases created.");
